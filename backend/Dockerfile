FROM python:3.11-slim

# âœ… libs Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù€ OpenCV Ùˆ Torch
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1 libglib2.0-0 libgomp1 curl ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Ù…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦Ø© Ø¹Ø§Ù…Ø©
ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=8080 \
    PYTHONPATH=/app

WORKDIR /app

# PyTorch CPU (Ù†Ø³Ø® Ù…ØªÙˆØ§ÙÙ‚Ø©)
RUN python -m pip install --no-cache-dir --extra-index-url https://download.pytorch.org/whl/cpu \
    torch==2.3.1+cpu torchvision==0.18.1+cpu

# Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª (ØªØ£ÙƒØ¯ Ø£Ù† requirements.txt ÙŠØ­ØªÙˆÙŠ opencv-python-headless)
COPY requirements.txt .
RUN python -m pip install --no-cache-dir -r requirements.txt

# Ù†Ø³Ø® Ø§Ù„Ø³ÙˆØ±Ø³
COPY backend ./backend
COPY backend/app ./app
RUN mkdir -p /tmp

# ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
RUN useradd -m appuser
USER appuser

EXPOSE 8080

# âœ… Ø§Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Cloud Run
# Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ bash -lc Ø¹Ø´Ø§Ù† ØªÙˆØ³Ø¹Ø© $PORT
CMD ["gunicorn", "app.main:app", "--bind", "0.0.0.0:8080", "--workers", "1", "--threads", "2", "--timeout", "120", "--max-requests", "10", "--max-requests-jitter", "5"]
